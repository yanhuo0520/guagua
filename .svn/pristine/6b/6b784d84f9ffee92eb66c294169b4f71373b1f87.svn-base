<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<title>聚农优享</title>
	<meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
	<link rel="stylesheet" href="css/reset.css">
	<link rel="stylesheet" href="css/public.css">
	<link rel="stylesheet" href="font/font_560087_tt31urijhi307ldi/iconfont.css">
	<link rel="stylesheet" href="css/index.css">
	<!-- <script src="./js/rem.js"></script> -->
	<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.8.0/dist/JsBarcode.all.min.js" ></script>
	<script src="./js/vue.js"></script>
	<script src="js/index.js"></script>
	<script src="js/axios.min.js"></script>
	<script type="text/javascript" src="js/publick.js?v=3"></script>
	<script type="text/javascript" src="js/api.js"></script>
	<script type="text/javascript" src="./js/jweixin-1.4.0.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vant@2.8.7/lib/index.css">
	<script src="https://cdn.jsdelivr.net/npm/vant@2.8.7/lib/vant.min.js"></script>
	<style>
		[v-cloak] {
			display: none;
		}
		
		html,body { font-size: 16px; height: 100%; }
		@media all and (max-width:375px) {
			body,html{
				font-size: 14px;
			}
		}
		@media only screen and (min-width: 414px) {
			body,html {
				font-size: 16px !important;
			}
		}
		@media only screen and (min-width: 480px) {
			body,html {
				font-size: 22px !important;
			}
		}
		#app { min-height: 100%; background: #f5f5f5; }
		div { box-sizing: border-box; }
		/* 无数据 */
		.no-data { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99;}
		.no-data .no-data-con { position: absolute;  width: 90%; top: 50%; left: 50%; transform: translate(-50%,-50%); text-align: center; }
		.no-data .no-data-con img { width: 100%; }
		.no-data .no-data-con .no-title{ font-size: 1.2rem; font-weight:600;  color:rgba(0,0,0,1);  }
		.no-data .no-data-con .no-desc { font-size: 0.9rem; font-weight:400; color:rgba(136,136,136,1); padding: 0.8rem 0; }
		.no-data .no-data-con .van-button { font-size: 0.9rem; font-weight:400; color:rgba(1,195,39,1); }
		/* 去使用弹窗 */
		.share-popup-con { width: 90%; background: transparent; }
		.share-popup-con .tit { position: absolute; top: 2.81%; left: 0; width: 100%; height: 16.6%; color: #c85002; font-size: 1.375rem; font-weight: bold;display: flex; align-items: center; justify-content: center; }
		.share-popup-con .imgcode-con { position: absolute;top: 22%; left: 0; width: 100%; height: 30%; display: flex; align-items: center; justify-content: center; }
		.share-popup-con .imgcode-con #imgcode { width: 70%; height: 100%; background: #000; }
		.share-popup-con .desc { position: absolute; top: 50%; left: 0; width: 100%; text-align: center; color:  rgba(75,75,75,0.5); font-size: 0.875rem;}
		.share-popup-con .btn-con { position: absolute; bottom: 14.45%;left: 6%; width: 88%; height: 10.71%; display: flex; align-items: center; justify-content: space-between; }
		.share-popup-con .btn-con .van-button { width: 46%; background: #fff; border: none; box-shadow: 0px 5px 5px 0px rgba(0,0,0,0.14); padding: 0; }
		.share-popup-con .btn-con .van-button .van-button__text{ color: #c85002; font-weight: bold;font-size: 1rem; }
		
		.share-mask { height: 100%; width: 100%; z-index: 20000; top: 0; left: 0; color: #fff; position: fixed; background: rgba(0, 0, 0, 0.8); }
		.share-mask-content p { padding-left: 20px; font-size: 28px; color: #fff }

		.img-show-con { width: 100%; height: 100%; background: transparent; }
		.img-show-con .img-con { position: absolute; top: 50%; width: 100%; transform: translateY(-50%); }
		/* 公众号 */
		.public { position: relative; top: 0; left: 0; width: 100%; background-color: #fff; z-index: 2002; display: flex; align-items: center; padding: 0.75rem; }
		.public .desc-con { flex: 1; }
		.public .desc-con .text { font-weight: bold; }
		.public .pointer { width: 30px; transform: rotate(90deg); margin-right: 10px; }
		.public .btn-con { border-radius: 100px; overflow: hidden; width: 6rem; height: 2rem; }
		.public .btn-con .van-button { width: 100%; height: 100%; padding: 0;  }

		/* 会员券弹窗 */
		.share-popup-con2 { width: 90%; background: transparent; }
		.share-popup-con2 .tit { position: absolute; top: 19%; left: 15%; width: 100%; color: #c85002; font-size: 1.375rem; font-weight: bold;display: flex; align-items: flex-start }
		.share-popup-con2 .tit img { width: 1.5rem; }
		.share-popup-con2 .tit .desc { display: flex; flex-direction: column; margin-left: 10px; }
		.share-popup-con2 .tit .desc .top { font-size: 1.25rem; color: #856001; padding-bottom: 3px; }
		.share-popup-con2 .tit .desc .bot { font-size: 0.875rem; font-weight: 400; color: #856001; }
		.share-popup-con2 .btn-con { position: absolute; top: 65%;left: 6%; width: 88%; height: 10.71%; display: flex; align-items: center; justify-content: space-between; }
		.share-popup-con2 .btn-con .van-button { width: 46%; background: #fff; border: none; box-shadow: 0px 5px 5px 0px rgba(0,0,0,0.14); padding: 0; }
		.share-popup-con2 .btn-con .van-button .van-button__text{ color: #c85002; font-weight: bold;font-size: 1rem; }
		.share-popup-con2 .btn2-con { position: absolute; top: 65%;left: 6%; width: 88%; height: 10.71%; display: flex; align-items: center; justify-content: center; }
		.share-popup-con2 .btn2-con .van-button { width: 100%; background: #fff; border: none; box-shadow: 0px 5px 5px 0px rgba(0,0,0,0.14); padding: 0; }
		.share-popup-con2 .btn2-con .van-button .van-button__text{ color: #c85002; font-weight: bold;font-size: 1rem; }
		
		/* .share-popup-con2 .bottom { position: absolute;bottom: 8%; left: 6%; width: 88%; height: 10%; padding: 0 10px; display: flex; align-items: center;justify-content: space-between; }
		.share-popup-con2 .bottom .item { display: flex; align-items: center; }
		.share-popup-con2 .bottom .item img { width: 21px; }
		.share-popup-con2 .bottom .item span { color: #fbf5dc; font-size: 0.9rem; margin-left: 10px; }
		.share-popup-con2 .bottom .shu { width: 1px; height: 100%; opacity: 0.59; border: 1px solid; border-image: linear-gradient(180deg, rgba(253,251,240,0), #fbf5dd 52%, rgba(251,245,220,0) 104%) 2 2; } */

	</style> 

</head>

<body>
	<div id="app" v-cloak>
		<div class="no-data" v-if="!isSuccess && !isErr">
			<div class="no-data-con">
				<img src="./images/no-search.png" alt="">
				<p class="no-title">扫码核销</p>
				<p class="no-desc">点击扫一扫,核销优惠券</p>
				<van-button v-if="isShopUser || isJoiner" size="small" plain round color="#01C327" @click="geScanQRCode()" >扫一扫</van-button>
			</div>
		</div>
		<div class="no-data" v-if="isSuccess && !isErr">
			<div class="no-data-con">
				<img src="./images/no-search.png" alt="">
				<p class="no-title">核销成功</p>
				<p class="no-desc">点击扫一扫,核销下一个</p>
				<van-button size="small" plain round color="#01C327" @click="geScanQRCode()" >扫一扫</van-button>
			</div>
		</div>
		<div class="no-data" v-if="isErr">
			<div class="no-data-con">
				<img :src="errImg" alt="">
				<p class="no-title">{{ errText ? errText : '核销失败' }}</p>
				<p class="no-desc">点击扫一扫,重新核销</p>
				<van-button size="small" plain round color="#01C327" @click="geScanQRCode()" >扫一扫</van-button>
			</div>
		</div>
		<van-popup :value="dialogShow" class="share-popup-con2" :close-on-click-overlay="false">
			<img src="./images/share-yhq-bg3.png" width="100%" alt="">
			<div class="tit">
				<img  :src="(isErr || isDistribution == null) ? './images/hexiao-icon2.png' : './images/hexiao-icon1.png'" alt="">
				<div class="desc">
					<div class="top">
						<template v-if="isDistribution == 0">
							<span>{{(isAll == 1 ? '通用' : '指定商品') + '券核销成功'}}</span>
						</template>
						<template v-if="isDistribution == 1">
							<span>分销券核销成功</span>
						</template>
						<template v-if="isDistribution == null">
							<template v-if="isErr">
								<span>{{errText}}</span>
							</template>
							<template v-else>
								<span v-if="!isShopUser && isJoiner" >您还不是商家</span>
								<span v-if="isShopUser && !isJoiner" >您还不是加盟方</span>
								<span v-if="!isShopUser && !isJoiner" >您还不是加盟方或商家</span>
							</template>
						</template>
					</div>
					<div class="bot">
						<template v-if="isDistribution == 0 || isDistribution == 1">
							<span>{{target_str}}</span>
						</template>
						<template v-if="isDistribution == null">
							<template v-if="isErr">
								<span>{{errDesc}}</span>
							</template>
							<template v-else>
								<span v-if="!isShopUser && isJoiner" >该功能为商家权限,请先入驻商家</span>
								<span v-if="isShopUser && !isJoiner" >该功能为加盟方,请先申请加盟方</span>
								<span v-if="!isShopUser && !isJoiner" >该功能为商家或者加盟方权限</span>
							</template>
						</template>
					</div>
				</div>
			</div>
			<div class="btn-con" v-if="isDistribution != null">
				<van-button type="primary" round @click="toPay()">查看可用商品</van-button>
				<van-button type="primary" round  @click="geScanQRCode()">继续核销</van-button>
			</div>
			<div class="btn2-con" v-if="isDistribution == null">
				<template v-if="isErr">
					<van-button type="primary" round @click="geScanQRCode()">{{errText == '获取条形码内容失败' ? '重新扫码' : '扫一扫'}}</van-button>
				</template>
				<template v-else>
					<template v-if="!isShopUser && isJoiner">
						<van-button type="primary" round @click="regShop()">入驻商家</van-button>
					</template>
					<template v-if="isShopUser && !isJoiner">
						<van-button type="primary" round @click="applyJoiner()">申请加盟方</van-button>
					</template>
					<template v-if="!isShopUser && !isJoiner">
						<van-button style="width: 46%;" type="primary" round @click="regShop()">入驻商家</van-button>
						<van-button style="width: 46%;" type="primary" round @click="applyJoiner()">申请加盟方</van-button>
					</template>
				</template>
			</div>
		</van-popup>
	</div>

	<script>
		
		var app = new Vue({
			el: '#app',
			data: {
				JumpUrl: {
					jssdkUrl: 'http://sy.xfd365.com/wx/jssdk2/getSignPackage',
					checkToken: 'http://sy.xfd365.com/wx/base/checkToken', //检查token
					token: 'http://sy.xfd365.com/wx/wechat/login', //微信登录
					scan_offline_coupon: baseUrl('/wx/coupon/scan_offline_coupon'),
					shopInfo: baseUrl('/wx/shop/shop_info'),
					if_sshop_owner: baseUrl('/wx/coupon/if_shop_owner'),
					changeShop: baseUrl('/wx/shop/changeShop'),
					check_role: baseUrl('/wx/distribution/check_role')
				},
				token: localStorage.getItem("token"),
				noDataImg: './images/icon/no-goods.png',
				errImg: './images/err.png',
				isSuccess: false,
				isErr: false,
				errText: '',
				errDesc: '',
				scanQrcodeId: '',

				isShopUser: false,
				isJoiner: false,
				isRequestShopUser: false,
				isRequestJoiner: false,

                shop_id: '',
				coupon_id: '',
				target_str: '',
				yxq: '',
				isAll: '',
				dialogShow: false,
				isDistribution: null

			},
			methods: {	
				wxSign() {
					var that = this;
					let back_url = window.location.href
					axios({
							method: 'post',
							// url: 'https://api.xfd365.com/wx/wechat/get_jump_url',
                            url: 'http://sy.xfd365.com/wx/wechat/get_jump_url',
							data: {
								back_url: encodeURIComponent(back_url),
							}
						})
						.then(function (resp) {
							//返回数据
							window.location.href = decodeURIComponent(resp.data.url);

						}).catch(function (error) {
							//请求失败
							console.log('error', error);
						})
				},
				wechatLogin: function () {
					var that = this;
					axios({
							method: 'post',
							url: that.JumpUrl.token,
							//data: form_data
							data: {
								code: that.code
							}
						})
						.then(function (resp) { //返回数据
							that.token = resp.data.token;
							localStorage.setItem('token', that.token);
							if (that.token) {
								that.getJssdk();
							}

						}).catch(function (error) {
							//请求失败
							console.log('error', error);

						})

				},
				//检查token是否过期
				checkToken() {
					var that = this;
					axios({
							method: 'post',
							url: that.JumpUrl.checkToken,
							data: {
								token: this.token
							}

						})
						.then(function (resp) {
							// console.log(resp.data)
							//返回数据
							if (resp.data.errno == 1) {
								//token过期调用跳转页面方法
								localStorage.removeItem('token')
								that.wxSign();
							} else {
								that.getJssdk();
							}
						}).catch(function (error) {
							//请求失败
							console.log('error', error);

						})
				},
				getJssdk: function () {
					let that = this;
					axios({
						method: 'post',
						url: that.JumpUrl.jssdkUrl,
						//data: form_data
						data: {
							token: that.token,
							url: encodeURIComponent(location.href.split('#')[0])
						}
					}).then(function (resp) {
						let data = resp.data
						let sdkData = resp.data
						wx.config({
							debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
							appId: sdkData.appId, // 必填，公众号的唯一标识
							timestamp: sdkData.timestamp, // 必填，生成签名的时间戳
							nonceStr: sdkData.nonceStr, // 必填，生成签名的随机串
							signature: sdkData.signature, // 必填，签名
							jsApiList: [
                                'scanQRCode',
								'updateAppMessageShareData',
								'updateTimelineShareData',
							] // 必填，需要使用的JS接口列表
						});
						that.getShopUser()
						that.getCheckRole()
						setTimeout(() =>{
							that.geScanQRCode()
						})
					})
				},
				// 注册商家
				regShop() {
					window.location.href = 'regShop.html'
				},
				// 申请加盟方
				applyJoiner() {
					this.$toast('申请加盟方')
					return
					window.location.href = 'regShop.html'
				},
				//切换店铺
				currentShop(id,callBack) {
					var that = this;
					axios({
						method: 'post',
						url: that.JumpUrl.changeShop,
						data: {
							shop_id: id,
							token: localStorage.getItem("token"),
						}
					})
					.then(function (resp) {
						if(resp.data.errno == 0) {
							callBack && typeof callBack == 'function' && callBack()
						}
					}).catch(function (error) {
						//请求失败
						console.log('error', error);

					})

				},
				// 查看当前券可用商品
				toPay() {
					if(this.isDistribution == 1) {
						// 分销券查看可用商品
						window.location.href = 'offLineCouponGoods.html?coupon_id='+this.coupon_id+'&target_str='+this.target_str+'&cur_yxq='+this.yxq+'&is_distribution=1&source=scanDestroy'
						return
					} else {
						if(this.isAll == 1) {
							this.currentShop(this.shop_id,() =>{
								window.location.href = 'offLineCouponGoods.html?coupon_id='+this.coupon_id+'&target_str='+this.target_str+'&cur_yxq='+this.yxq+'&isAll='+this.isAll+'&source=scanDestroy'
							})
							return
						}
						window.location.href = 'offLineCouponGoods.html?coupon_id='+this.coupon_id+'&target_str='+this.target_str+'&cur_yxq='+this.yxq+'&isAll='+this.isAll+'&source=scanDestroy'
					}
				},
				// 判断是否为商家
				getShopUser() {
					let that = this;
					axios({
						method: 'post',
						url: that.JumpUrl.if_shop_owner,
						data: { token: localStorage.getItem('token') }
					})
					.then(function (resp) { //返回数据
						if(resp.data.code == 1) {
							if(Number(resp.data.data) > 0) {
								that.shop_id = resp.data.data
								that.isShopUser = true
							} else {
								that.isShopUser = false
							}
						} else {
							that.isShopUser = false
						}
					}).catch(function (error) {
						that.isShopUser = false
						//请求失败
						console.log('error', error);

					})
				},
				// 判断是否为加盟方
				getCheckRole() {
					let that = this;
					axios({
						method: 'post',
						url: that.JumpUrl.check_role,
						data: { token: localStorage.getItem('token') }
					})
					.then(function (resp) { //返回数据
						if(resp.data.errno == 0) {
							if(resp.data.is_joiner == 2) {
								that.isJoiner = true
							} else {
								that.isJoiner = false
							}
						} else {
							that.isJoiner = false
						}
					}).catch(function (error) {
						that.isJoiner = false
						//请求失败
						console.log('error', error);

					})
				},
				// 核销优惠券
				scanOffCoupon() {
					var that = this;
					that.isSuccess = false;
					that.isErr = false;
					that.dialogShow = false 
					that.errText = '';
					that.errDesc = ''
					that.isDistribution = null;
					axios({
						method: 'post',
						url: that.JumpUrl.scan_offline_coupon,
						data: {
							token: that.token,
							coupon_info: that.scanQrcodeId,
						}

					})
					.then(function (resp) {
						that.dialogShow = true 
						if (resp.data.errno == 0) {
							let data = resp.data.coupon
							that.isSuccess = true;
							that.isErr = false
							that.isDistribution = data.is_distribution
							that.coupon_id = data.coupon_id 
							that.target_str = data.target_limit == 0 ? '无门槛使用' : ('使用门槛：满'+ data.target + '可用')
							that.yxq = '有效期:'+ dateFormat('yyyy.MM.dd',new Date((data.yxq_start +'').length == 10 ? data.yxq_start*1000 : data.yxq_start)) + '-' + dateFormat('yyyy.MM.dd',new Date((data.yxq_end +'').length == 10 ? data.yxq_end*1000 : data.yxq_end)) 
							that.isAll = resp.data.coupon.goods_type == 0 ? 1 : 2
						} else {
							that.isErr = true
							that.errText = resp.data.msg;
						}
					}).catch(function (error) {
						that.dialogShow = true 
						that.isErr = true
						that.errText = '网络错误请稍后重试'
						console.log('error', error);
					})
				},
				// 调用微信扫一扫
                geScanQRCode() {
					let that = this;
					// if(that.shop_id == '') return
                    that.isErr = false
					that.dialogShow = false 
                    that.errText = ''
					that.errDesc = ''
                    wx.ready(function () {  
						wx.scanQRCode({
							needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
							scanType: ["barCode"], // 可以指定扫二维码还是一维码，默认二者都有
							success: function(res) {
								var result = res.resultStr.split(','); // 当needResult 为 1 时，扫码返回的结果
                                if(result[0] == 'CODE_128') {
                                    // 走正常核销接口
									that.scanQrcodeId = result[1]
									that.scanOffCoupon()
                                } else {
									that.dialogShow = true
                                    that.isErr = true
                                    that.errText = '获取条形码内容失败'
									that.errDesc = '错误代码'+result[0]+',请重新扫码'
                                }
							},
							fail: function(err) {
								that.dialogShow = true	
								that.isErr = true
								that.errText = '调用扫码功能失败'
								that.errDesc = '点击扫一扫,重新调用'
							}
							});
					
					});       
                }

			},
			created: function () {
				let code = getQueryString('code');
				if (code) {
					this.code = code;
				}
				let token = localStorage.getItem('token')
				if (this.code) {
					this.wechatLogin()
				} else {
					if (token) {
						this.checkToken()
					} else {
						this.wxSign()
					}
				}
			}
		})
	</script>
</body>

</html>